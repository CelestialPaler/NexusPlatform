# Nexus Analyzer Core 架构设计与规划说明书

> **版本**: v0.1.0-Draft
> **日期**: 2026-01-20
> **作者**: Maxwell's Demon
> **状态**: 规划中

## 1. 愿景 (Vision)
**"Do one thing and do it well."**
Nexus Analyzer Core (NAC) 旨在构建一套**模块化、可独立运行、标准化输出**的 Python 网络/媒体分析工具箱。它将作为 Nexus 可视化平台的“后端引擎”，同时也支持作为独立的 CLI 工具链在服务器或嵌入式设备上运行。

## 2. 核心架构 (Core Architecture)

系统采用 **"三层解耦 (Three-Tier Decoupled)"** 架构，将数据的解析(Process)、存储(Storage)与展示(Presentation)彻底分离。

```mermaid
graph TD
    %% Layer 3: Application / Consumer
    subgraph "Layer 3: Presentation (Consumer)"
        NexusGUI[Nexus Platform GUI]
        WebDashboard[Web Dashboard]
        AutoBot[CI/CD Bot]
    end

    %% Interface
    NexusGUI -->|spawn process| CLI[Nexus CLI Endpoint]
    AutoBot -->|shell exec| CLI

    %% Layer 2: Domain Plugins (The Toolbox)
    subgraph "Layer 2: Domain Plugins (The Toolbox)"
        CLI --> Dispatcher{Dispatcher}
        
        subgraph "Domain: Wi-Fi"
            P_QoS[QoS & TID Analysis]
            P_Airtime[Airtime Usage]
            P_Ba[BlockAck & Retransmission]
        end
        
        subgraph "Domain: Media"
            P_RTP[RTP Jitter/Loss]
            P_H264[H.264/NAL Analysis]
            P_MPEG[MPEG2-TS Parser]
        end
        
        subgraph "Domain: Protocol"
            P_TCP[TCP Handshake/Performance]
            P_Miracast[RTSP/Control Events]
        end
        
        Dispatcher --> P_QoS & P_Airtime & P_Ba
        Dispatcher --> P_RTP & P_H264 & P_MPEG
        Dispatcher --> P_TCP & P_Miracast
    end

    %% Layer 1: Foundation
    subgraph "Layer 1: Foundation (Core Libs)"
        PcapEngine[Pcap Parser (Scapy/DPKT)]
        Storage[Storage Engine (SQLite/JSON)]
        Config[Config Manager]
        Logger[Unified Logger]
    end
    
    P_QoS & P_RTP & P_Miracast -.-> PcapEngine
    P_QoS & P_RTP & P_Miracast -.-> Storage

    %% Data Output
    subgraph "Data Output Artifacts"
        JSON[summary.json (KPIs/Conclusions)]
        SQLite[trace.db (Massive Details)]
        Log[analysis.log (Process Info)]
    end

    Storage --> JSON & SQLite
    NexusGUI -.->|Read| JSON & SQLite
```

---

## 3. 详细设计 (Detailed Design)

### 3.1 交互协议 (Interaction Protocol)
所有分析插件必须遵循统一的 I/O 标准，以确保上层 GUI 可以无脑调用。

*   **输入 (Input)**: 统一 CLI 参数接口。
    ```bash
    # 典型调用范例
    python -m nexus_core analyze --plugin wifi.qos \
        --input ./capture.pcapng \
        --output ./result_dir \
        --params '{"target_mac": "aa:bb:cc:...", "tid_filter": [0, 5]}'
    ```
*   **通信 (Communication)**:
    *   `STDOUT`: 仅输出 Human-readable 的运行日志（方便人工调试）或 JSON 格式的进度信息（`{"progress": 45, "status": "parsing..."}`）。
    *   `STDERR`: 仅输出严重的运行错误。
*   **输出 (Output)**: 必须生成两个核心文件。
    1.  **`summary.json`**: 
        *   存放高维度结论、统计值、异常告警。
        *   用于 GUI 首页概览展示（Dashboard）。
        *   例：`{"avg_retry": 0.15, "is_congested": true, "alerts": ["SN Flip detected at frame 900"]}`
    2.  **`trace.sqlite`**:
        *   存放海量的逐帧明细数据。
        *   用于 GUI 的交互式图表（Time Series）、表格筛选。
        *   表结构例：`frames (no, timestamp, tid, seq, size, is_retry, rssi)`。

### 3.2 目录结构 (Directory Structure)

```text
Nexus-Analyzer-Core/
├── nexus_core/                 # [Layer 1] 核心框架代码
│   ├── __init__.py
│   ├── cli.py                  # CLI 入口与参数解析器
│   ├── engine.py               # 插件加载与调度器
│   ├── database.py             # SQLite ORM / Helper
│   ├── pcap_reader.py          # 高性能 Pcap 读取封装
│   └── utils.py                # 日志、文件处理工具
├── plugins/                    # [Layer 2] 分析工具箱 (可扩展)
│   ├── wifi/
│   │   ├── qos_analyzer.py     # 移植原 analyze_qos.py
│   │   ├── airtime.py          # 空口分析
│   │   └── interference.py     # 干扰分析
│   ├── media/
│   │   ├── rtp_jitter.py       # 移植原 analyze_jitter.py
│   │   └── h264_deep.py        # 移植原 analyze_media_deep.py
│   └── protocol/
│       └── miracast_flow.py    # 移植原 analyze_miracast.py
├── tests/                      # 单元测试与集成测试
├── requirements.txt
├── setup.py                    # 安装脚本
└── README.md
```

### 3.3 关键技术选型 (Tech Stack)

*   **语言**: Python 3.10+ (强制 Type Hinting)
*   **Pcap 解析**: 
    *   `Scapy` (灵活性高，用于协议层/逻辑层分析)
    *   `DPKT` / `PyShark` (高性能备选，用于流量统计层)
*   **数据处理**: `Pandas` (核心计算), `NumPy`
*   **数据存储**: `SQLite3` (标准库，无需额外 Server)
*   **CLI 框架**: `Argparse` 或 `Click`
*   **打包**: `PyInstaller` (生成独立 exe 供无 Python 环境使用)

---

## 4. 演进路线 (Roadmap)

### Phase 1: 基础设施 (Infrastructure)
*   [ ] 建立 `nexus_core` 包结构。
*   [ ] 实现 `SQLiteWriter` 类，统一处理数据落盘。
*   [ ] 实现统一的 CLI 入口框架。

### Phase 2: 核心插件迁移 (Migration)
*   [ ] **Wi-Fi QoS**: 移植并重构 `analyze_qos.py`，支持 SQLite 输出。
*   [ ] **RTP/Jitter**: 移植 `analyze_jitter.py`。
*   [ ] **Miracast**: 移植 `analyze_miracast.py`，整合上述两者的能力。

### Phase 3: GUI 集成 (Integration)
*   [ ] Nexus Platform (Frontend) 增加 `ProcessManager` 模块。
*   [ ] 实现前端读取 SQLite 并使用 ECharts 渲染百万级数据点的能力（聚合/降采样）。
*   [ ] 定义 `summary.json` 的标准 Schema，实现自动生成报告页。

### Phase 4: 高级特性 (Advanced)
*   [ ] **Multi-Point Analysis**: 支持同时输入 Air 和 Wire 抓包，工具自动同步时间轴与关联流。
*   [ ] **Custom Rules**: 允许用户编写简单的 Python/Lua 脚本作为临时检测规则。

---

## 5. 设计哲学 (Philosophy)

> *"Simple is better than complex."*
> *"Explicit is better than implicit."*

1.  **无状态 (Stateless)**: 每个分析任务都是独立的进程，分析完即销毁，不驻留内存。
2.  **数据即接口 (Files as Interface)**: GUI 和 Core 之间没有复杂的 Socket/RPC，只有文件系统（Pcap In -> SQLite Out）。这使得调试极为简单。
3.  **可测试 (Testable)**: 所有的分析逻辑都可以通过 Assert 进行单元测试，不需要启动 GUI。

---

**文档维护者**: Maxwell's Demon
**最后更新**: 2026-01-20
